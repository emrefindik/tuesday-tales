<!DOCTYPE html>
<html>
<body style="margin: 0" onresize="resizeMap()">
<style>
    #wrapper { position: relative; }
    #map { z-index: 1 }
    #statsscreen { position: absolute; top: 5px; right: 5px; width: 50%; height: 25%; z-index: 99; background-color: #eeeeee; border-size: 3px; border-style: solid; border-color: #444444}
    #scoretextdiv { position: absolute; top: 5%; left: 5%; width: 50%; height: 30%; }
    #timertextdiv { position: absolute; bottom: 35%; left: 5%; width: 50%; height: 30%; }
    #multipliertextdiv { position: absolute; bottom: 5%; left: 5%; width: 50%; height: 30%; }
    #scorevalue { position: absolute; top: 5%; right: 5%; width: 40%; height: 30%; }
    #timervalue { position: absolute; bottom: 35%; right: 5%; width: 40%; height: 30%; }
    #multipliervalue { position: absolute; bottom: 5%; right: 5%; width: 40%; height: 30%; }
    h1 { font-size: 20px; }
    
</style>
<div id="wrapper">
<div id="map"></div>
<div id="statsscreen">
    <div id="scoretextdiv"><h1 id="scoretext">Score:</h1></div>
    <div id="timertextdiv"><h1 id="timetext">Time:</h1></div>
    <div id="multipliertextdiv"><h1 id="multipliertext">Combo:</h1></div>
    <div id="scorevalue"><h1 id="score"></h1></div>
    <div id="timervalue"><h1 id="time"></h1></div>
    <div id="multipliervalue"><h1 id="multiplier"></h1></div>
    </div>
</div>
<script>
// furthest distance to fetch markers from, in meters
markerRadius = 6000;
score = 0;

function resizeMap() {
	document.getElementById("map").style.height = window.innerHeight.toString().concat("px");
	document.getElementById("map").style.width = window.innerWidth.toString().concat("px");
}

function updateScore(newScore)
{
    score = newScore;
    document.getElementById("score").innerHTML = newScore.toString();
}

function updateMultiplier(newMultiplier)
{
    document.getElementById("multiplier").innerHTML = newMultiplier.toString();
}

secondsRemaining = 0;
function startTimer(seconds)
{
    secondsRemaining = seconds - 1;
    imer = setInterval(updateTimer, 1000);
    updateDisplayedTime();
}

function updateDisplayedTime()
{
    var secondText = (secondsRemaining % 60).toString();
    if (secondsRemaining % 60 < 10)
    {
        secondText = "0" + secondText;
    }
    document.getElementById("time").innerHTML = Math.floor(secondsRemaining / 60).toString() + ": " + secondText;
}

function timeout()
{
    clearInterval(timer);
    updateScore(0);
    // no need to display the timer
    document.getElementById("timetext").innerHTML = "";
    document.getElementById("timervalue").innerHTML = "";
    window.location.href = "uniwebview://resetscore";}

function updateTimer()
{
    if (secondsRemaining == 0)
    {
        timeout();
        return;
    }
    secondsRemaining = secondsRemaining - 1;
    updateDisplayedTime();
}

function onMarkerClick(markerId, lat, lon, markerType) {
	window.location.href = "uniwebview://marker?id=" + markerId + "&lat="+lat+"&lon="+lon+"&type=" + markerType;
}

function BackControl(controlDiv) {

	// Set CSS for the control border.
	var controlUI = document.createElement('div');
	controlUI.style.backgroundColor = '#fff';
	controlUI.style.border = '2px solid #fff';
	controlUI.style.borderRadius = '3px';
	controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
	controlUI.style.cursor = 'pointer';
	controlUI.style.marginBottom = '22px';
	controlUI.style.textAlign = 'center';
	controlUI.title = 'Click to go back to the menu';
	controlDiv.appendChild(controlUI);

	// Set CSS for the control interior.
	var controlText = document.createElement('div');
	controlText.style.color = 'rgb(25,25,25)';
	controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
	controlText.style.fontSize = '14px';
	controlText.style.lineHeight = '38px';
	controlText.style.paddingLeft = '5px';
	controlText.style.paddingRight = '5px';
	controlText.innerHTML = 'Back to Menu';
	controlUI.appendChild(controlText);

	// Setup the click event listeners: simply set the map to Chicago.
	controlUI.addEventListener('click', function() {
		window.location.href = "uniwebview://back";
	});
}

function initializeMap() {
	map = new google.maps.Map(document.getElementById('map'), {
		center: {lat: latitude, lng: longitude},
		zoom: 16
	});
	mapCenter = map.getCenter();
	google.maps.event.addDomListener(map, 'idle', function() {
		mapCenter = map.getCenter();
	});
	google.maps.event.addDomListener(window, 'resize', function() {
		map.setCenter(mapCenter);
	});
	markers.forEach(function(spatialMarker) {		
		var googleMarker = new google.maps.Marker({
			position: {lat: spatialMarker.loc.coordinates[1], lng: spatialMarker.loc.coordinates[0]},
			map: map,
			label: {
				color: "yellow",
				fontSize: "35px",
				fontWeight: "bold",
				text: spatialMarker.name
			},
			icon: {
				anchor: {
					x: 81,
					y: 108
				},
				scaledSize: {
					width: 162,
					height: 216
				},
				//url: "http://www.etc.cmu.edu/wp-content/uploads/2013/08/Xiao-Bao-1.png"
			},
			title: spatialMarker.name
		});		
		// TODO uncomment this after fixing the problem of metadata being saved as strings
		//googleMarker.addListener('click', function() { onMarkerClick(spatialMarker._id, spatialMarker.metadata.type); });
		googleMarker.addListener('click', function() { onMarkerClick(spatialMarker._id, spatialMarker.loc.coordinates[1], spatialMarker.loc.coordinates[0], "no type"); });
	});
	//var backButtonDiv = document.createElement('div');
    //var backControl = new BackControl(backButtonDiv);

    //backButtonDiv.index = 1;
    //map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push(backButtonDiv);
    meLocation = new google.maps.Marker({
                                              position: {lat: latitude, lng: longitude},
                                              map: map,
                                              icon: {
                                              anchor: {
                                              x: 15,
                                              y: 15
                                              },
                                              scaledSize: {
                                              width: 30,
                                              height: 30
                                              },
                                              //url: "http://www.etc.cmu.edu/wp-content/uploads/2013/08/Xiao-Bao-1.png"
                                                url: "http://matthewestone.com/PhotoTest/58deb4c133627.png"
                                              }
    });
    
    pathCoordinates = [];
    
}

// lat = latitude the player is currently at
// lon = longitude the player is currently at
// baseURL = the Spatial server base URL
// projectID = the Spatial project ID
function loadMap(lat, lon, baseURL, projectID, startScore, timerSeconds, multiplier) {
	
	// initialize location variables globally
	latitude = lat;
	longitude = lon;
	
	// get markers and store them into a global variable
	var getReq = new XMLHttpRequest();
	getReq.onreadystatechange = function() {
		if (getReq.readyState == 4) {
			if (getReq.status == 200) {
				markers = JSON.parse(getReq.responseText).markers;
			} else {
				console.log(getReq.status.toString() + " error, no markers received from Spatial");
				markers = [];
			}
			// run the googlemaps script. it will run initializeMap in turn
			var googleMapsScript = document.createElement('script');
			googleMapsScript.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyCejidwxDYN4APVvtlE7ZPsBtVdhB7JG70&callback=initializeMap";
			document.getElementsByTagName("body")[0].appendChild(googleMapsScript);
		}
	};
	getReq.open('GET', baseURL + "/v1/markers-by-distance?longitude=" +
		longitude.toString() + "&latitude=" + latitude.toString() + "&projectId=" +
		projectID + "&meters=" + markerRadius.toString(), true);
	getReq.send();
    
    updateScore(startScore);
    updateMultiplier(multiplier);
    if (score == 0)
    {
        // no need to display the "Time:" text
        document.getElementById("timetext").innerHTML = "";
    }
    else
    {
        startTimer(timerSeconds);
    }
    
}

function updateCurrentLocation(lat, lon){
    latitude = lat;
    longitude = lon;
    var newLatLng = new google.maps.LatLng(latitude, longitude);
    meLocation.setPosition(newLatLng);
}

function addPointToPath(la, lo, sc, time, mult){
    updateScore(sc);
    updateMultiplier(mult);
    startTimer(time);
    pathCoordinates.push({lat:la, lng:lo});
    var destroyPath = new google.maps.Polyline({
                                              path: pathCoordinates,
                                              geodesic: true,
                                              strokeColor: '#EE1100',
                                              strokeOpacity: 1.0,
                                              strokeWeight: 2
                                              });
                                              
    destroyPath.setMap(map);
}

resizeMap();
loadMap(40.432645, -79.964834, "https://spatial-api-poc.herokuapp.com", "58b070d3b4c96e00118b66ee");


</script>
</body>
</html>
