<!DOCTYPE html>
<html>
<body style="margin: 0" onresize="resizeMap()">
<style>
    #wrapper { position: relative; }
    #map { z-index: 1 }
    #statsscreen { position: absolute; top: 0px; right: 0px; left: 0px; bottom: 0px; width: 100%; height: 100%; z-index: 99; pointer-events: none}
    #frameimage {position:absolute; top: 0px; right: 0px; left: 0px; bottom: 0px; width: 100%; height: 100%;}
    #timervalue { position: absolute; top: 9%; width: 100%; height: 10%; text-align: center; font-size: 7vw;}
    #resourceimage{position: absolute; top:8%; left: 10%; right: 20%; width: 6vw; height: 6vw; margin: auto}
    #scorevalue { position: absolute; top: 6.8%; left: 20%; right: 20%; width: 4vw; height: 4vw; margin: auto}
    #multipliertextdiv { position: absolute; top: 3.3%; left:10%; right:20%; height: 10%; text-align: center; font-size: 5vw;}
    #multipliervalue { position: absolute; top: 0%; left: 25%; right:12%; height: 10%; text-align: center; font-size: 4vw;}
    h1{ text-align: center; }
    #multiplier { font-size: 6vw; }
    #score { font-size: 4vw;}
    #time { font-size: 6vw; }
    

    #scoretextdiv { position: absolute; top: 5%; left: 5%; width: 50%; height: 30%; }
    #timertextdiv { position: absolute; bottom: 35%; left: 5%; width: 50%; height: 30%; }
    
    #eggsDiv { position: absolute; right: 15%; bottom: 5%; width: 30%; z-index: 99 }
    #eggsDummy { height: 0; margin-top: 66%; }
    #eggsButton { position: absolute; top: 0; left: 0; width: 100%; height: 100% }
    #kaijuDiv { position: absolute; left: 15%; bottom: 5%; width: 30%; z-index: 99 }
    #kaijuDummy { height: 0; margin-top: 66%; }
	#kaijuButton { position: absolute; top: 0; left: 0; width: 100%; height: 100% }
    #cameraDiv { position: absolute; bottom: 5%; margin-left: auto; margin-right: auto; left: 0; right: 0; width: 18%; z-index: 99 }
    #cameraDummy { height: 0; margin-top: 100%; }
	#cameraButton { position: absolute; top: 0; left: 0; width: 100%; height: 100% }
    
</style>
<div id="wrapper">
	<div id="map"></div>
	<div id="statsscreen">
        <img id="frameimage" src="Frame_with_timer.png"></img>
        <img id="resourceimage" src="Fossile_coin.png"</img>
        <div id="multipliervalue"><h1 id="multiplier"></h1></div>
        <div id="scorevalue"><h1 id="score"></h1></div>
        <div id="multipliertextdiv"> Combo x <h1 id="multipliertext"></h1></div>
        <div id="timervalue"><h1 id="time"></h1></div>
            
        <!--
		<div id="scoretextdiv"><h1 id="scoretext">Score:</h1></div>
		<div id="timertextdiv"><h1 id="timetext">Time:</h1></div>
		<div id="multipliertextdiv"><h1 id="multipliertext">Combo:</h1></div>
		<div id="scorevalue"><h1 id="score"></h1></div>
		<div id="timervalue"><h1 id="time"></h1></div>
		<div id="multipliervalue"><h1 id="multiplier"></h1></div>
         -->
    </div>
    <div id="kaijuDiv"><div id="kaijuDummy"></div><img id="kaijuButton" src="Kaiju_button.png" onclick="toKaiju()"></img></div>
    <div id="cameraDiv"><div id="cameraDummy"></div><img id="cameraButton" src="Minus_button.png"></img></div>
    <div id="eggsDiv"><div id="eggsDummy"></div><img id="eggsButton" src="Egg_button.png" onclick="toEggs()"></img></div>
	<!--
    <button id="eggsButton" onclick="toEggs()">Look at Your Eggs</button>
	<button id="kaijuButton" onclick="toKaiju()">Select Your Kaiju</button>
	<button id="cameraButton" onclick="toCamera()">Take a Photo</button>
     -->
</div>
<script>
// furthest distance to fetch markers from, in meters
markerRadius = 6000;
score = 0;
maxCheckInDistance = 50;
document.getElementById("time").innerHTML = "00" + ": " + "00";



function toEggs() {
	window.location.href = "uniwebview://eggs";
}

function toKaiju() {
	window.location.href = "uniwebview://kaiju";
}

function toCamera() {
	window.location.href = "uniwebview://camera";
}

function deg2rad(deg) {
	return deg * (Math.PI / 180);
}

function withinDistance(lat1, lon1, lat2, lon2, radius) {
    return radius > getDistanceFromLatLonInM(lat1, lon1, lat2, lon2);
}

function withinDistance(loc1, loc2, radius){
    return radius > getDistanceFromLatLonInM(loc1.lat(), loc1.lng(), loc2.lat(), loc2.lng());
}

function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
	var dLat = deg2rad(lat2-lat1);
	var dLon = deg2rad(lon2-lon1);
	var a = 
		Math.sin(dLat/2) * Math.sin(dLat/2) +
		Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
		Math.sin(dLon/2) * Math.sin(dLon/2); 
	return (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))) * 6371000;
}

function updateCurrentLocation(lat, lon){
    latitude = lat;
    longitude = lon;
    var newLatLng = new google.maps.LatLng(latitude, longitude);
    //meLocation.setPosition(newLatLng);
	meLocation.setCenter(newLatLng);
}

function resizeMap() {
	document.getElementById("map").style.height = window.innerHeight.toString().concat("px");
	document.getElementById("map").style.width = window.innerWidth.toString().concat("px");
}

function updateScore(newScore)
{
    score = newScore;
    document.getElementById("score").innerHTML = newScore.toString();
}

function updateMultiplier(newMultiplier)
{
    document.getElementById("multiplier").innerHTML = newMultiplier.toString();
}

/*secondsRemaining = 0;
function startTimer(seconds)
{
    secondsRemaining = seconds - 1;
    timer = setInterval(updateTimer, 1000);
    updateDisplayedTime();
} */

function updateDisplayedTime(secondsRemaining)
{
    if (secondsRemaining < 0)
    {
        if (score > 0) timeout();
    }
    else
    {
        var secondText = (secondsRemaining % 60).toString();
        if (secondsRemaining % 60 < 10) {
            secondText = "0" + secondText;
        }
        document.getElementById("time").innerHTML = Math.floor(secondsRemaining / 60).toString() + ": " + secondText;
    }
}

function timeout()
{
    //clearInterval(timer);
    updateScore(0);
	updateMultiplier(1);
	pathMarkerSpatialIds = []
	updatePath();
	
	// no need to display the timer
	document.getElementById("timetext").innerHTML = "";
	document.getElementById("time").innerHTML = "";
	
	// let Spatial know that the player timed out
    //window.location.href = "uniwebview://resetscore";
}

function onMarkerClick(markerId, markerPosition) {
	//if (withinDistance(meLocation.getPosition(), markerPosition, maxCheckInDistance)) {  OLD CODE
	//if (withinDistance(meLocation.getCenter(), markerPosition, maxCheckInDistance)) {  NEW CODE
		window.location.href = "uniwebview://destroy?id=" + markerId;
	//} else {
		// TODO show error screen
	//}
}

function updatePath() {
	var newPath = [];
	googleMarkers.forEach(function(marker) {
		for (var i = 0; i < pathMarkerSpatialIds.length; i++) {
			if (pathMarkerSpatialIds[i] == marker.spatialId) {
				newPath[i] = marker.getPosition();
                marker.inPath = true;
				marker.setMap(null);
				marker.intactOverlay.setMap(null);
				if (map.getZoom() > 15)
                    marker.destroyedOverlay.setMap(map);
				return;
			}
		}
		// we know marker is not in path
        marker.inPath = false;
        if (map.getZoom() > 15) {
            marker.setMap(map);
            marker.intactOverlay.setMap(map);
        }
		marker.destroyedOverlay.setMap(null);
	});
	newPath = newPath.filter(function(n){ return n != undefined });
	destroyPath.setPath(newPath);
}

function initializeMap() {
	map = new google.maps.Map(document.getElementById('map'), {
		center: {lat: latitude, lng: longitude},
		zoom: 16
	});
	mapCenter = map.getCenter();
	google.maps.event.addDomListener(map, 'idle', function() {
		mapCenter = map.getCenter();
	});
	google.maps.event.addDomListener(window, 'resize', function() {
		map.setCenter(mapCenter);
	});
	
    /*meLocation = new google.maps.Marker({
                                              position: {lat: latitude, lng: longitude},
                                              map: map,
                                              icon: {
                                              anchor: {
                                              x: 15,
                                              y: 15
                                              },
                                              scaledSize: {
                                              width: 30,
                                              height: 30
                                              },
                                              //url: "http://www.etc.cmu.edu/wp-content/uploads/2013/08/Xiao-Bao-1.png"
                                                url: "http://matthewestone.com/PhotoTest/58deb4c133627.png"
                                              }
    }); */
	
	meLocation = new google.maps.Circle({
                                              center: {lat: latitude, lng: longitude},
											  map: map,
                                              radius: maxCheckInDistance,
											  strokeColor: "#161616",
											  strokeOpacity: 0.3,
											  strokeWeight: 2,
											  fillColor: "#2062B3",
											  fillOpacity: 0.3
    });

	destroyPath = new google.maps.Polyline({
                                              path: [],
                                              geodesic: true,
                                              strokeColor: '#EE1100',
                                              strokeOpacity: 1.0,
                                              strokeWeight: 2
                                              });
                                              
    destroyPath.setMap(map);
	googleMarkers = [];
	spatialMarkers.forEach(function(spatialMarker) {
		switch (spatialMarker.metadata.type) {
			case "building":
				var googleMarker = new google.maps.Marker({
					position: {lat: spatialMarker.loc.coordinates[1], lng: spatialMarker.loc.coordinates[0]},
					label: {
						fontSize: "14px",
						fontWeight: "bold",
						text: spatialMarker.name
					},
					title: spatialMarker.name
				});
				googleMarker.spatialId = spatialMarker._id;
                googleMarker.inPath = false;
				googleMarker.addListener('click', function() { onMarkerClick(spatialMarker._id, googleMarker.getPosition()); });
				googleMarker.intactOverlay = new google.maps.GroundOverlay(spatialMarker.metadata.intactImagePath, spatialMarker.metadata.imageBounds);
				googleMarker.destroyedOverlay = new google.maps.GroundOverlay(spatialMarker.metadata.destroyedImagePath, spatialMarker.metadata.imageBounds);
				// TODO check if intactImagePath or destroyedImagePath exists, otherwise load map overlay
				googleMarkers.push(googleMarker);
				break;
			case "overlay":
				var mapOverlay = new google.maps.GroundOverlay(spatialMarker.metadata.intactImagePath, spatialMarker.metadata.imageBounds, {opacity: 1.0});
				mapOverlay.setMap(map);
				break;
			default:
				break;
		}
	});
	updatePath();
	
	google.maps.event.addListener(map, 'zoom_changed', function() {
		if (map.getZoom() <= 15) {
			googleMarkers.forEach(function(marker){
				marker.setMap(null);
                marker.intactOverlay.setMap(null);
                marker.destroyedOverlay.setMap(null);
			});
		} else {                           
			googleMarkers.forEach(function(marker){
                if (marker.inPath)
                {
                    marker.destroyedOverlay.setMap(map);
                }
                else
                {
                    marker.setMap(map);
                    marker.intactOverlay.setMap(map);
                }
			});
		}
	});
	
	//var mapOverla = new google.maps.GroundOverlay("http://tuesday-tales.etc.cmu.edu/Photos/cmumap.jpg", { north: 40.445924, south: 40.439190, east: -79.936435, west: -79.948635 }, {opacity: 0.2});
	//mapOverla.setMap(map);
}

// lat = latitude the player is currently at
// lon = longitude the player is currently at
// baseURL = the Spatial server base URL
// projectID = the Spatial project ID
    //function loadMap(lat, lon, baseURL, projectID, startScore, timerSeconds, multiplier, pathMarkerIds) {
function loadMap(lat, lon, baseURL, projectID, startScore, multiplier, pathMarkerIds) {
	// initialize location variables globally
	latitude = lat;
	longitude = lon;
	
	pathMarkerSpatialIds = pathMarkerIds.list;
	
	// get markers and store them into a global variable
	var getReq = new XMLHttpRequest();
	getReq.onreadystatechange = function() {
		if (getReq.readyState == 4) {
			if (getReq.status == 200) {
				spatialMarkers = JSON.parse(getReq.responseText).markers;
			} else {
				console.log(getReq.status.toString() + " error, no markers received from Spatial");
				spatialMarkers = [];
			}
			// run the googlemaps script. it will run initializeMap in turn
			var googleMapsScript = document.createElement('script');
			googleMapsScript.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyCejidwxDYN4APVvtlE7ZPsBtVdhB7JG70&callback=initializeMap";
			document.getElementsByTagName("body")[0].appendChild(googleMapsScript);
		}
	};
	getReq.open('GET', baseURL + "/v1/markers-by-distance?longitude=" +
		longitude.toString() + "&latitude=" + latitude.toString() + "&projectId=" +
		projectID + "&meters=" + markerRadius.toString(), true);
	getReq.send();
    
    updateScore(startScore);
    updateMultiplier(multiplier);
    if (score == 0)
    {
        // no need to display the timer
        document.getElementById("timetext").innerHTML = "";
    }
    /*else
    {
        startTimer(timerSeconds);
    } */
    
}

resizeMap();
//loadCheckInMap(40.43, -79.96, "https://spatial-api-poc.herokuapp.com", "58b070d3b4c96e00118b66ee", 0, 0, 1, [], 40, {_markersToTake: [], _genericLocationsToTake: []});
loadMap(40.43, -79.96, "https://spatial-api-poc.herokuapp.com", "58b070d3b4c96e00118b66ee", 0, 1, { list: [] });
</script>
</body>
</html>
